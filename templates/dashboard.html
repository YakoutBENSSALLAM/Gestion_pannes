{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>📊 Tableau de Bord</h1>
        <p>Vue d'ensemble des pannes et statistiques</p>
    </div>
    <div class="header-actions">
        <div class="export-buttons">
            <a href="{{ url_for('export_excel') }}" class="btn btn-success">📊 Export Excel</a>
            <a href="{{ url_for('export_pdf') }}" class="btn btn-danger">📄 Export PDF</a>
        </div>
    </div>
</div>

<!-- Statistiques principales -->
<div class="stats-grid">
    <div class="stat-card stat-total">
        <div class="stat-icon">📈</div>
        <div class="stat-content">
            <h3>{{ stats.total }}</h3>
            <p>Total des pannes</p>
        </div>
    </div>

    <div class="stat-card stat-pending">
        <div class="stat-icon">⏳</div>
        <div class="stat-content">
            <h3>{{ stats.en_attente }}</h3>
            <p>En attente</p>
        </div>
    </div>

    <div class="stat-card stat-progress">
        <div class="stat-icon">🔄</div>
        <div class="stat-content">
            <h3>{{ stats.en_cours }}</h3>
            <p>En cours</p>
        </div>
    </div>

    <div class="stat-card stat-resolved">
        <div class="stat-icon">✅</div>
        <div class="stat-content">
            <h3>{{ stats.resolues }}</h3>
            <p>Résolues</p>
        </div>
    </div>
</div>

<!-- Graphique de répartition -->
<div class="chart-container">
    <h2>📊 Répartition des pannes par état</h2>
    <div class="chart-wrapper">
        <div class="pie-chart">
            <div class="pie-slice pie-pending"
                 style="--percentage: {{ (stats.en_attente / stats.total * 100) if stats.total > 0 else 0 }}%">
                <span class="pie-label">En attente</span>
            </div>
            <div class="pie-slice pie-progress"
                 style="--percentage: {{ (stats.en_cours / stats.total * 100) if stats.total > 0 else 0 }}%">
                <span class="pie-label">En cours</span>
            </div>
            <div class="pie-slice pie-resolved"
                 style="--percentage: {{ (stats.resolues / stats.total * 100) if stats.total > 0 else 0 }}%">
                <span class="pie-label">Résolues</span>
            </div>
        </div>
        <div class="chart-legend">
            <div class="legend-item">
                <div class="legend-color legend-pending"></div>
                <span>En attente ({{ stats.en_attente }})</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-progress"></div>
                <span>En cours ({{ stats.en_cours }})</span>
            </div>
            <div class="legend-item">
                <div class="legend-color legend-resolved"></div>
                <span>Résolues ({{ stats.resolues }})</span>
            </div>
        </div>
    </div>
</div>

<!-- Pannes récentes -->
<div class="recent-pannes">
    <div class="section-header">
        <h2>🕒 Pannes récentes</h2>
        <a href="{{ url_for('historique') }}" class="btn btn-secondary">Voir tout</a>
    </div>

    {% if pannes_recentes %}
    <div class="recent-list">
        {% for panne in pannes_recentes %}
        <div class="recent-item panne-{{ panne.etat.lower().replace(' ', '-').replace('é', 'e') }}">
            <div class="recent-header">
                <div class="recent-title">
                    <strong>{{ panne.equipement }}</strong>
                    <span class="recent-id">#{{ panne.id }}</span>
                </div>
                <div class="recent-meta">
                    <span class="priority-badge priority-{{ panne.priorite.lower() }}">
                        {% if panne.priorite == 'Critique' %}🔴
                        {% elif panne.priorite == 'Élevée' %}🟠
                        {% elif panne.priorite == 'Moyenne' %}🟡
                        {% else %}🟢
                        {% endif %}
                        {{ panne.priorite }}
                    </span>
                    <span class="status-badge status-{{ panne.etat.lower().replace(' ', '-').replace('é', 'e') }}">
                        {% if panne.etat == 'En attente' %}⏳
                        {% elif panne.etat == 'En cours' %}🔄
                        {% elif panne.etat == 'Résolue' %}✅
                        {% else %}🔒
                        {% endif %}
                        {{ panne.etat }}
                    </span>
                </div>
            </div>
            <div class="recent-description">
                {{ panne.description[:120] }}{% if panne.description|length > 120 %}...{% endif %}
            </div>
            <div class="recent-footer">
                <span class="recent-date">📅 {{ panne.date_creation.split(' ')[0] }}</span>
                <a href="{{ url_for('modifier_panne', panne_id=panne.id) }}" class="btn btn-small btn-edit">✏️ Modifier</a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-recent">
        <p>Aucune panne récente à afficher</p>
        <a href="{{ url_for('ajouter_panne') }}" class="btn btn-primary">➕ Ajouter une panne</a>
    </div>
    {% endif %}
</div>

<!-- Actions rapides -->
<div class="quick-actions">
    <h2>⚡ Actions rapides</h2>
    <div class="actions-grid">
        <a href="{{ url_for('ajouter_panne') }}" class="action-card action-add">
            <div class="action-icon">➕</div>
            <h3>Nouvelle Panne</h3>
            <p>Enregistrer une nouvelle panne</p>
        </a>

        <a href="{{ url_for('historique') }}" class="action-card action-history">
            <div class="action-icon">📋</div>
            <h3>Historique</h3>
            <p>Consulter toutes les pannes</p>
        </a>

        <div class="action-card action-stats">
            <div class="action-icon">📈</div>
            <h3>Statistiques</h3>
            <p>Taux de résolution : {{ ((stats.resolues / stats.total * 100) | round(1)) if stats.total > 0 else 0 }}%</p>
        </div>

        <div class="action-card action-urgent">
            <div class="action-icon">🚨</div>
            <h3>Pannes critiques</h3>
            <p>{{ stats.en_attente + stats.en_cours }} en cours de traitement</p>
        </div>
    </div>
</div>

<script>
    // Animation des compteurs au chargement de la page
    document.addEventListener('DOMContentLoaded', function () {
        const counters = document.querySelectorAll('.stat-content h3');

        counters.forEach(counter => {
            const target = parseInt(counter.textContent);
            const increment = target / 50;
            let current = 0;

            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    counter.textContent = target;
                    clearInterval(timer);
                } else {
                    counter.textContent = Math.floor(current);
                }
            }, 30);
        });
    });
</script>
{% endblock %}